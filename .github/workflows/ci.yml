name: CI

# Trigger workflow on pull requests to main branch
on:
  pull_request:
    branches:
      - main

# Set permissions for CI and PR comments
permissions:
  contents: read
  pull-requests: write

jobs:
  # CI job to verify build and run tests
  ci:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository code
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Setup Node.js 20 with npm caching
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # Step 3: Install dependencies using npm ci for clean, reproducible installs
      - name: Install dependencies
        run: npm ci

      # Step 4: Verify snapshot files exist before running tests
      - name: Verify Snapshot Files
        run: |
          echo "Checking for snapshot files..."
          SNAPSHOT_DIR="src/lib/docker-compose/__tests__/__verify__/__snapshots__"
          if [ ! -d "$SNAPSHOT_DIR" ]; then
            echo "Error: Snapshot directory not found at $SNAPSHOT_DIR"
            exit 1
          fi
          SNAPSHOT_COUNT=$(find "$SNAPSHOT_DIR" -name "*.snap" | wc -l)
          echo "Found $SNAPSHOT_COUNT snapshot file(s):"
          ls -la "$SNAPSHOT_DIR"/*.snap
          if [ "$SNAPSHOT_COUNT" -eq 0 ]; then
            echo "Error: No snapshot files found in $SNAPSHOT_DIR"
            exit 1
          fi
          echo "Snapshot files verified successfully."

      # Step 5: Build project and verify TypeScript compilation
      - name: Build
        run: npm run build

      # Step 6: Run test suite using vitest
      - name: Test
        run: npm test

      # Step 7: Report test results with PR comment
      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ job.status }}';
            const emoji = outcome === 'success' ? '✅' : '❌';
            const message = `${emoji} CI check result: **${outcome === 'success' ? 'Passed' : 'Failed'}**

            **Workflow**: CI
            **Status**: ${outcome}
            **Branch**: ${{ github.head_ref }}
            **Commit**: ${{ github.sha }}

            ${outcome === 'success' ?
              'All tests passed and build completed successfully.' :
              'Please check the logs for details and fix any issues before merging.'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
